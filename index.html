<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏≤‡∏´‡∏•‡∏≠‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;700&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <style>
        body { background: #020202; color: #b9b9b9; font-family: 'Noto Sans Thai', sans-serif; line-height: 2.3; }
        .glass-card { background: rgba(10, 10, 10, 0.98); border: 1px solid #1a1a1a; border-radius: 12px; }
        .story-puead { text-align: justify; font-size: 1.15rem; color: #dcdcdc; word-break: break-all; }
        .btn-horror { background: linear-gradient(135deg, #450a0a, #991b1b); transition: 0.3s; cursor: pointer; color: white; font-weight: bold; }
        .btn-horror:disabled { opacity: 0.5; cursor: not-allowed; }
        .image-prompt-box { background: #080808; border: 1px dashed #444; padding: 15px; border-radius: 8px; margin-top: 25px; position: relative; }
        .loader { border: 4px solid #111; border-top: 4px solid #991b1b; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .horror-font { font-family: 'Cinzel', serif; }
        .error-box { background: #1a0505; border: 1px solid #450a0a; color: #991b1b; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 0.9rem; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div class="max-w-4xl mx-auto">
        <h1 class="horror-font text-5xl text-red-900 text-center mb-10">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏≤‡∏´‡∏•‡∏≠‡∏ô</h1>

        <div id="setup" class="glass-card p-8 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á" class="bg-black border border-gray-800 p-3 rounded w-full outline-none text-white">
                <input type="text" id="char" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡πÄ‡∏ö‡∏•/‡∏°‡∏≠‡∏™)" class="bg-black border border-gray-800 p-3 rounded w-full outline-none text-white">
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <label class="text-xs text-gray-500 font-bold">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≠‡∏ô (6-9): <span id="lv-num" class="text-red-700">7</span></label>
                    <input type="range" id="horror-slider" min="6" max="9" value="7" class="w-full mt-2 accent-red-900">
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡πà‡∏≠‡∏ô: <span id="chapter-num" class="text-red-700">2</span></label>
                    <input type="range" id="chapter-slider" min="1" max="10" value="2" class="w-full mt-2 accent-red-900">
                </div>
            </div>

            <textarea id="keywords" placeholder="‡∏õ‡∏°‡∏™‡∏¢‡∏≠‡∏á..." class="bg-black border border-gray-800 p-3 rounded w-full outline-none text-white" rows="3"></textarea>
            <button onclick="startRitual()" class="btn-horror w-full p-4 rounded uppercase tracking-widest hover:opacity-90">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏ó</button>
        </div>

        <div id="story-display" class="glass-card p-10 hidden mt-10">
            <h2 id="st-title" class="horror-font text-3xl text-red-700 mb-8 border-b border-red-900 pb-4"></h2>
            <div id="chapters-container"></div>
            
            <div id="loading-area" class="hidden text-center py-10">
                <div class="loader mb-4"></div>
                <p id="loading-text" class="italic text-red-900 animate-pulse font-bold"></p>
            </div>

            <div id="error-area" class="hidden error-box"></div>

            <div id="actions" class="mt-10 flex flex-col gap-4">
                <button id="next-btn" onclick="fetchNextChapter()" class="btn-horror hidden w-full p-4 rounded hover:opacity-90">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ö‡∏ó‡∏ó‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‚Üí</button>
                <button onclick="location.reload()" class="w-full text-gray-700 text-[10px] uppercase py-4 hover:text-gray-500">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>
    </div>

    <script>
        // üî¥ ‡πÉ‡∏™‡πà API Key ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        const API_KEY = "AIzaSyC3MRGR8DB7lra7R1ZKngSnEltPhMIeQFI"; 
        
        let currentChapter = 0;
        let totalChapters = 1;
        let storyHistory = [];
        let isLoading = false;

        function getHorrorDescription(level) {
            const descriptions = {
                6: "‡∏´‡∏•‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á: ‡πÄ‡∏ô‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡∏•‡∏∂‡∏Å‡∏•‡∏±‡∏ö ‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢ ‡∏à‡∏¥‡∏ï‡∏ï‡∏Å ‡πÄ‡∏á‡∏≤‡∏Ñ‡∏•‡∏∏‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠ ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏à‡∏ô‡∏ô‡πà‡∏≤‡∏≠‡∏∂‡∏î‡∏≠‡∏±‡∏î ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏µ‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ï‡∏±‡∏ß‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏î ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏¢",
                7: "‡∏´‡∏•‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á: ‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏õ‡∏•‡∏Å ‡πÄ‡∏á‡∏≤‡∏û‡∏£‡∏≤‡∏¢ ‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏≠‡∏±‡∏ö‡∏ä‡∏∑‡πâ‡∏ô ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ñ‡∏π‡∏Å‡∏à‡πâ‡∏≠‡∏á‡∏°‡∏≠‡∏á ‡∏ú‡∏µ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö ‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏î ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢",
                8: "‡∏´‡∏•‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á (YouTube-Friendly): ‡∏ú‡∏µ‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ï‡∏±‡∏ß ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏¢‡∏î‡∏™‡∏¢‡∏≠‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ß‡πÉ‡∏ô‡∏à‡∏¥‡∏ï‡πÉ‡∏à ‡∏ß‡∏¥‡πà‡∏á‡∏´‡∏ô‡∏µ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏î ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏ß‡∏±‡∏¢‡∏ß‡∏∞ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏¢‡πÇ‡∏´‡∏î ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ü‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏ï‡∏≤‡∏¢",
                9: "‡∏´‡∏•‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏∏‡∏î‡∏Ç‡∏µ‡∏î (YouTube-Safe): ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡πâ‡∏≤ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏≠‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏â‡∏≤‡∏Å‡∏Ü‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏ï‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏î ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏ó‡∏≤‡∏á‡πÄ‡∏û‡∏® ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢‡πÄ‡∏î‡πá‡∏Å ‡πÑ‡∏°‡πà‡∏´‡∏°‡∏¥‡πà‡∏ô‡∏®‡∏≤‡∏™‡∏ô‡∏≤ ‡πÄ‡∏ô‡πâ‡∏ô‡∏à‡∏¥‡∏ï‡∏ï‡∏Å ‡∏´‡∏•‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏° ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÑ‡∏î‡πâ"
            };
            return descriptions[level] || descriptions[7];
        }

        document.getElementById('horror-slider').oninput = function() { 
            document.getElementById('lv-num').innerText = this.value; 
        };
        document.getElementById('chapter-slider').oninput = function() { 
            document.getElementById('chapter-num').innerText = this.value; 
        };

        async function startRitual() {
            // ‡πÄ‡∏ä‡πá‡∏Ñ API Key
            if (API_KEY === "‡πÉ‡∏™‡πà_API_Key_‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ" || !API_KEY) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 83)");
                return;
            }

            totalChapters = parseInt(document.getElementById('chapter-slider').value);
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('story-display').classList.remove('hidden');
            document.getElementById('st-title').innerText = document.getElementById('title').value || "‡∏ö‡∏ó‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ú‡∏µ";
            await fetchNextChapter();
        }

        function getLastSentence(text) {
            const parts = text.split('...').filter(p => p.trim().length > 0);
            return parts.slice(-2).join('...') + '...';
        }

        function cleanStoryText(text) {
            if (currentChapter === 1) return text;
            
            const introPatterns = [
                /‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ú‡∏µ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡πÅ‡∏ï‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ü‡∏±‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏•‡∏≠‡∏ô.*?‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÜ/gs,
                /‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÜ\s+‡∏ú‡∏°‡∏ä‡∏∑‡πà‡∏≠[^.]+?\.\.\./s,
                /‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏°‡∏à‡∏∞‡πÄ‡∏•‡πà‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ.*?‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ú‡∏°‡πÑ‡∏õ‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏•\.\.\./s,
                /‡∏ú‡∏°‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á.*?‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö/gs
            ];
            
            let cleaned = text;
            for (const pattern of introPatterns) {
                cleaned = cleaned.replace(pattern, '');
            }
            return cleaned.replace(/^\s+/, '').trim();
        }

        function ensureOutro(text) {
            const outroSequence = [
                "‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πá‡∏à‡∏ö‡∏•‡∏á",
                "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°",
                "‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≠‡∏ô",
                "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏≤‡∏´‡∏•‡∏≠‡∏ô",
                "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö"
            ];
            
            let lastIndex = -1;
            const missing = [];
            
            for (const part of outroSequence) {
                const idx = text.indexOf(part);
                if (idx === -1) {
                    missing.push(part);
                } else if (idx < lastIndex) {
                    missing.push(`${part} (‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ú‡∏¥‡∏î)`);
                } else {
                    lastIndex = idx;
                }
            }
            
            if (missing.length > 0) {
                let cleaned = text;
                outroSequence.forEach(part => {
                    cleaned = cleaned.replace(new RegExp(part.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '.*?', 'g'), '');
                });
                cleaned = cleaned.replace(/‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö\s*$/, '').trim();
                
                return cleaned + ` ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πá‡∏à‡∏ö‡∏•‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö... ... ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°... ‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏¥‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô... ... ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≠‡∏ô... ... ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠‡πÑ‡∏õ... ... ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏ö‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà... ‡∏ó‡∏µ‡πà... ... ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏≤‡∏´‡∏•‡∏≠‡∏ô... ... ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö`;
            }
            
            return text;
        }

        function validateImagePrompt(img, title, keywords) {
            if (!img || typeof img !== 'string') return null;
            
            const trimmed = img.trim();
            if (trimmed.length < 50) return null;
            
            const genericPatterns = [
                /^cinematic horror scene.*dark atmosphere.*photorealistic.*8k$/i,
                /^horror scene.*dark.*photorealistic$/i
            ];
            
            for (const pattern of genericPatterns) {
                if (pattern.test(trimmed)) return null;
            }
            
            const hasSpecificDetail = /(character|scene|environment|lighting|mood|atmosphere|detailed|specific)/i.test(trimmed);
            if (!hasSpecificDetail) return null;
            
            return trimmed;
        }

        function generateFallbackImagePrompt(title, keywords, chapter, isLastChapter) {
            const baseContext = `${title}, ${keywords}`;
            
            if (isLastChapter) {
                return `Cinematic horror finale of ${baseContext}, climactic scene, intense atmosphere, dramatic lighting, detailed environment, photorealistic, 8k, highly detailed, emotional impact`;
            } else if (chapter === 1) {
                return `Cinematic horror opening of ${baseContext}, mysterious atmosphere, establishing shot, detailed environment, photorealistic, 8k, highly detailed, moody lighting`;
            } else {
                return `Cinematic horror scene ${chapter} of ${baseContext}, escalating tension, detailed environment, atmospheric lighting, photorealistic, 8k, highly detailed`;
            }
        }

        async function fetchNextChapter() {
            if (isLoading) return;
            
            currentChapter++;
            isLoading = true;
            setLoading(true, `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏ó‡∏ó‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${currentChapter}/${totalChapters}...`);
            document.getElementById('next-btn').classList.add('hidden');
            hideError();

            const charName = document.getElementById('char').value || "‡πÄ‡∏ö‡∏•";
            const lv = document.getElementById('horror-slider').value;
            const horrorDesc = getHorrorDescription(parseInt(lv));
            const title = document.getElementById('title').value || "‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏•‡∏≠‡∏ô";
            const keywords = document.getElementById('keywords').value || "‡∏ö‡πâ‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏á";

            const isLastChapter = currentChapter === totalChapters;
            
            const previousEnding = storyHistory.length > 0 
                ? getLastSentence(storyHistory[storyHistory.length - 1])
                : null;

            let storyOutline = "";
            if (currentChapter === 1) {
                storyOutline = `[Outline ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ${totalChapters} ‡∏ó‡πà‡∏≠‡∏ô]\n` +
                    Array.from({length: totalChapters}, (_, i) => {
                        const num = i + 1;
                        const isLast = num === totalChapters;
                        const isFirst = num === 1;
                        if (isFirst) return `‡∏ó‡πà‡∏≠‡∏ô ${num}: ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà + ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô + ‡∏ó‡∏¥‡πâ‡∏á‡∏õ‡∏°`;
                        if (isLast) return `‡∏ó‡πà‡∏≠‡∏ô ${num}: Climax + ‡∏ï‡∏≠‡∏ô‡∏à‡∏ö + Outro`;
                        return `‡∏ó‡πà‡∏≠‡∏ô ${num}: ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô + ‡∏ó‡∏¥‡πâ‡∏á‡∏õ‡∏°`;
                    }).join('\n') + 
                    `\n\n‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡πà‡∏≠‡∏ô 1 ‡∏ï‡∏≤‡∏° Outline ‡∏ô‡∏µ‡πâ`;
            } else {
                storyOutline = `[Outline ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ${totalChapters} ‡∏ó‡πà‡∏≠‡∏ô]\n` +
                    Array.from({length: totalChapters}, (_, i) => {
                        const num = i + 1;
                        const isLast = num === totalChapters;
                        const isCurrent = num === currentChapter;
                        const status = num < currentChapter ? '‚úÖ' : (isCurrent ? 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô' : '‚è≥');
                        if (num === 1) return `${status} ‡∏ó‡πà‡∏≠‡∏ô ${num}: ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà + ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô`;
                        if (isLast) return `${status} ‡∏ó‡πà‡∏≠‡∏ô ${num}: Climax + ‡∏ï‡∏≠‡∏ô‡∏à‡∏ö + Outro`;
                        return `${status} ‡∏ó‡πà‡∏≠‡∏ô ${num}: ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô`;
                    }).join('\n') +
                    `\n\n[‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡∏ó‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏ö‡∏ó‡∏µ‡πà: "${previousEnding}"\n‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏≤‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ Intro ‡∏ã‡πâ‡∏≥`;
            }

            let positionPrompt = "";
            
            if (currentChapter === 1) {
                positionPrompt = `[‡∏ó‡πà‡∏≠‡∏ô‡πÅ‡∏£‡∏Å/${totalChapters}]
- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ Hook 1-2 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ
- ‡∏ï‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢ Intro: "‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ú‡∏µ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡πÅ‡∏ï‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ü‡∏±‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏•‡∏≠‡∏ô... ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏Å‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏û‡∏ß‡∏Å‡πÄ‡∏£‡∏≤‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ô‡∏±‡πà‡∏á‡∏ü‡∏±‡∏á‡πÉ‡∏ô '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏≤‡∏´‡∏•‡∏≠‡∏ô' ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà‡πÜ... ... ‡∏ú‡∏°‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á--‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏Ç‡∏≠‡πÄ‡∏•‡πà‡∏≤‡πÅ‡∏ó‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á... ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÜ ‡∏ú‡∏°‡∏ä‡∏∑‡πà‡∏≠${charName}‡∏Ñ‡∏£‡∏±‡∏ö... ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏°‡∏à‡∏∞‡πÄ‡∏•‡πà‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ ‡∏°‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ú‡∏°‡πÑ‡∏õ‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏•..."
- ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏ö ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏¥‡πâ‡∏á‡∏õ‡∏°‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏ß‡πâ`;

            } else if (isLastChapter) {
                positionPrompt = `[‡∏ó‡πà‡∏≠‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ${currentChapter}/${totalChapters}]
üî¥ ‡∏´‡πâ‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î:
- ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ Intro ‡∏´‡∏£‡∏∑‡∏≠ Hook
- ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà
- ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:
- Climax (‡∏à‡∏∏‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á)
- ‡∏ï‡∏≠‡∏ô‡∏à‡∏ö‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
- Outro ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î`;

            } else {
                positionPrompt = `[‡∏ó‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á ${currentChapter}/${totalChapters}]
- ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ Intro
- ‡∏´‡πâ‡∏≤‡∏°‡∏à‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á
- ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ó‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
- ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô
- ‡∏ó‡∏¥‡πâ‡∏á‡∏õ‡∏°‡πÑ‡∏ß‡πâ‡∏ï‡πà‡∏≠`;
            }

            const prompt = `[Role: ‡∏ô‡∏±‡∏Å‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ú‡∏µ‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏≤‡∏´‡∏•‡∏≠‡∏ô"]
[Task: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß 1,700-1,800 ‡∏Ñ‡∏≥ + Image Prompt]

${storyOutline}

${positionPrompt}

[CRITICAL RULES]
1. ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ß‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏õ‡∏∑‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
2. ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞: ... (2‡∏ß‡∏¥), ... ... (3-4‡∏ß‡∏¥), -- (‡∏ñ‡∏≠‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à)
3. ‡∏™‡∏£‡∏£‡∏û‡∏ô‡∏≤‡∏°: "‡∏ú‡∏°" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

[Tone: ${lv}/10] ${horrorDesc}

[Content: ${title}, ${keywords}]

${currentChapter > 1 ? `[‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ]: "${previousEnding}"` : ''}

${isLastChapter ? `[Outro ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö]:
‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πá‡∏à‡∏ö‡∏•‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö... ... ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°... ‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏¥‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô... ... ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≠‡∏ô... ... ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠‡πÑ‡∏õ... ... ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏ö‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà... ‡∏ó‡∏µ‡πà... ... ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏≤‡∏´‡∏•‡∏≠‡∏ô... ... ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö` : ''}

[Visual Task]
PROMPT_SPLIT + Image Prompt ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 50 ‡∏Ñ‡∏≥ ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏â‡∏≤‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≤‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ)`;

            try {
                const result = await fetchWithRetry(prompt, title, keywords, isLastChapter);
                
                if (result) {
                    storyHistory.push(result.story);
                    renderChapter(currentChapter, result.story, result.image);
                    
                    if (isLastChapter) {
                        document.getElementById('next-btn').classList.add('hidden');
                    } else {
                        document.getElementById('next-btn').classList.remove('hidden');
                    }
                }
                
            } catch (e) { 
                showError("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
                console.error(e);
            } finally {
                isLoading = false;
                setLoading(false);
            }
        }

        async function fetchWithRetry(prompt, title, keywords, isLastChapter, maxRetries = 2) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { 
                                temperature: 0.4, 
                                maxOutputTokens: 8192 
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                        throw new Error("Invalid response structure");
                    }
                    
                    let text = data.candidates[0].content.parts[0].text;
                    
                    text = cleanStoryText(text);
                    
                    if (isLastChapter) {
                        text = ensureOutro(text);
                    }
                    
                    let story, img;
                    if (text.includes("PROMPT_SPLIT")) {
                        [story, img] = text.split("PROMPT_SPLIT");
                    } else {
                        story = text;
                        img = "";
                    }
                    
                    story = story.trim();
                    img = img ? img.trim() : "";
                    
                    let validatedImg = validateImagePrompt(img, title, keywords);
                    
                    if (!validatedImg) {
                        validatedImg = generateFallbackImagePrompt(title, keywords, currentChapter, isLastChapter);
                    }
                    
                    if (story.length > 500) {
                        return { story, image: validatedImg };
                    } else {
                        throw new Error("Story too short");
                    }
                    
                } catch (e) {
                    console.error(`Attempt ${attempt} failed:`, e);
                    if (attempt === maxRetries) {
                        throw e;
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            return null;
        }

        function renderChapter(num, story, img) {
            const container = document.getElementById('chapters-container');
            const section = document.createElement('div');
            section.className = "mb-16 pb-10 border-b border-gray-900";
            section.id = `chapter-${num}`;
            
            const escapedImg = img.replace(/'/g, "\\'").replace(/"/g, '\\"');
            
            section.innerHTML = `
                <div class="text-red-900 font-bold mb-4 italic">‡∏ö‡∏ó‡∏ó‡∏µ‡πà ${num} / ${totalChapters}</div>
                <div class="story-puead">${story}</div>
                <div class="image-prompt-box mt-6">
                    <button class="bg-zinc-900 text-[10px] px-2 py-1 absolute top-2 right-2 rounded hover:bg-zinc-800" 
                            onclick="navigator.clipboard.writeText('${escapedImg}');alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Prompt ‡πÅ‡∏•‡πâ‡∏ß!')">COPY</button>
                    <div class="text-[10px] text-gray-600 font-bold uppercase mb-1">Image Prompt</div>
                    <p class="text-xs text-gray-500">${img}</p>
                </div>
            `;
            container.appendChild(section);
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function setLoading(is, text) {
            document.getElementById('loading-area').classList.toggle('hidden', !is);
            document.getElementById('loading-text').innerText = text || '';
            document.getElementById('next-btn').disabled = is;
        }

        function showError(msg) {
            const errorBox = document.getElementById('error-area');
            errorBox.innerText = msg;
            errorBox.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('error-area').classList.add('hidden');
        }
    </script>
</body>
</html>
